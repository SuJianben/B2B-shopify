{% comment %} --- 1. 面包屑数据 --- {% endcomment %}
{% capture breadcrumb_json %}
[
  {"text": "HOME", "link": "{{ routes.root_url }}"},
  {"text": "{{ collection.title | escape }}", "link": "{{ collection.url }}"}
]
{% endcapture %}

{% comment %} --- 2. 产品数据 & 分页数据 (关键修改) --- {% endcomment %}
{% paginate collection.products by 12 %}
  {% capture collection_products_json %}
  [
    {% for prod in collection.products %}
      {
        "id": {{ prod.id }},
        "title": "{{ prod.title | escape }}",
        "url": "{{ prod.url }}",
        "image": "{{ prod.featured_image | image_url: width: 600 }}",
        "price": {{ prod.price }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% endcapture %}

  {% comment %} [新增] 捕获分页元数据 {% endcomment %}
  {% capture pagination_json %}
  {
    "current_page": {{ paginate.current_page }},
    "total_pages": {{ paginate.pages }},
    "total_items": {{ paginate.items }},
    "page_size": {{ paginate.page_size }}
  }
  {% endcapture %}
{% endpaginate %}

{% comment %} --- 3. 侧边栏菜单 --- {% endcomment %}
{% assign sidebar_linklist = linklists[section.settings.sidebar_menu] %}
{% capture sidebar_menu_json %}
[
  {% for link in sidebar_linklist.links %}
    {
      "title": "{{ link.title | escape }}",
      "url": "{{ link.url }}",
      "active": {{ link.active }},
      "child_active": {{ link.child_active }},
      "children": [
        {% for child_link in link.links %}
          {
            "title": "{{ child_link.title | escape }}",
            "url": "{{ child_link.url }}",
            "active": {{ child_link.active }}
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }{% unless forloop.last %},{% endunless %}
  {% endfor %}
]
{% endcapture %}

{% comment %} --- 4. 侧边栏推荐 --- {% endcomment %}
{% assign sidebar_rec_collection = collections[section.settings.sidebar_rec_collection] %}
{% assign sidebar_rec_title = section.settings.sidebar_rec_title | default: 'RECOMMENDED' %}
{% capture sidebar_rec_json %}
[
  {% if sidebar_rec_collection != blank %}
    {% for prod in sidebar_rec_collection.products limit: 3 %}
      {
        "title": "{{ prod.title | escape }}",
        "url": "{{ prod.url }}",
        "image": "{{ prod.featured_image | image_url: width: 200 }}",
        "desc": "{{ prod.content | strip_html | truncatewords: 8 | escape }}"
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  {% endif %}
]
{% endcapture %}

{% comment %} --- 5. Banner 图片逻辑 --- {% endcomment %}
{% assign target_image = section.settings.custom_banner %}
{% if target_image == blank %}
  {% assign target_image = collection.image %}
{% endif %}
{% if target_image != blank %}
  {% assign banner_bg = target_image | image_url: width: 1920 %}
{% else %}
  {% assign banner_bg = 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png' %}
{% endif %}

<div
  id="vue-collection-app"
  class="vue-section-full-width"
  data-collection-title="{{ collection.title | escape }}"
  data-products="{{ collection_products_json | escape }}"
  data-pagination="{{ pagination_json | escape }}"
  data-breadcrumbs="{{ breadcrumb_json | escape }}"
  data-banner-img="{{ banner_bg }}"
  data-sidebar-menu="{{ sidebar_menu_json | escape }}"
  data-sidebar-rec="{{ sidebar_rec_json | escape }}"
  data-sidebar-rec-title="{{ sidebar_rec_title | escape }}"
></div>

{% schema %}
{
  "name": "Vue Collection Main",
  "settings": [
    {
      "type": "header",
      "content": "Banner Settings"
    },
    {
      "type": "image_picker",
      "id": "custom_banner",
      "label": "Custom Banner Image"
    },
    {
      "type": "header",
      "content": "Sidebar Settings"
    },
    {
      "type": "link_list",
      "id": "sidebar_menu",
      "label": "Sidebar Menu"
    },
    {
      "type": "header",
      "content": "Sidebar Recommendations"
    },
    {
      "type": "text",
      "id": "sidebar_rec_title",
      "label": "Title",
      "default": "RECOMMENDED"
    },
    {
      "type": "collection",
      "id": "sidebar_rec_collection",
      "label": "Recommended Collection"
    }
  ],
  "presets": [
    {
      "name": "Vue Collection Main"
    }
  ]
}
{% endschema %}
